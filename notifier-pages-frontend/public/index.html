<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>On-Call Schedule</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* (기존 스타일 유지) */
    body {
      font-family: 'Inter', 'SF Pro Display', sans-serif;
      margin: 0;
      background-color: #f6f7f8;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding-bottom: 60px;
      text-align: center;
    }
    .container {
      max-width: 450px;
      width: 100%;
      margin: 0 auto;
      flex-grow: 1;
    }
    .header {
      padding: 15px 16px 10px 16px;
      position: sticky;
      top: 0;
      background-color: #f6f7f8;
      z-index: 10;
    }
    .header h1 { font-size: 1.2rem; font-weight: 700; color: #101922; margin: 0 0 15px; }
    .month-selector { display: flex; align-items: center; justify-content: center; gap: 15px; }
    .month-selector .arrow { font-size: 1.5rem; cursor: pointer; color: #6c757d; }
    .month-selector h2 { font-size: 1.1rem; font-weight: 600; color: #101922; margin: 0; }

    .schedule-list { padding: 0 16px; margin-bottom: 20px; }

    .schedule-card {
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      margin-bottom: 8px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .schedule-card.today {
      border: 2px solid #137fec;
      box-shadow: 0 2px 8px rgba(19, 127, 236, 0.2);
    }
    .card-date { display: flex; flex-direction: column; align-items: center; width: 60px; position: relative; }
    .day-num { font-weight: 700; font-size: 1.1rem; color: #101922; }
    .day-name { font-size: 0.95rem; color: #6c757d; }
    .day-name.weekend-sat { color: #137fec; }
    .day-name.weekend-sun { color: #dc3545; }
    .duty-icon { position: absolute; top: 50%; transform: translateY(-50%); left: -2px; font-size: 1.1rem; transition: color 0.2s; }
    .day-icon { color: #ffc107; }
    .night-icon { color: #4a5482; }
    .mixed-icon { color: #f96d00; }

    .card-duties { flex-grow: 1; display: flex; justify-content: space-between; align-items: center; border-left: 1px solid #eee; padding-left: 20px; color: #555; font-size: 1.0rem; }
    .day-duty-col { flex: 1; text-align: center; font-weight: 500; }
    .night-duty-col { flex: 1; text-align: center; font-weight: 500; }

    #settings-modal {
      display: none; position: fixed; top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.45); backdrop-filter: blur(3px);
      justify-content: center; align-items: center; z-index: 1000;
      animation: fadeIn 0.25s ease-out;
    }
    #settings-modal .modal-content {
      background: #fff; border-radius: 18px; width: 92%; max-width: 380px;
      padding: 24px 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      animation: scaleUp 0.25s ease-out; position: relative; text-align: left;
      box-sizing: border-box;
    }
    #settings-modal input {
      width: calc(100% - 4px);
      box-sizing: border-box;
      padding: 9px 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ddd;
      background-color: #f7f8fa;
      margin-top: 20px;
      margin-bottom: 30px;
      transition: all 0.2s;
    }
    #settings-modal input:focus { border-color: #137fec; background-color: #fff; outline: none; }
    .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; }
    .button { border: none; border-radius: 8px; padding: 10px 16px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: background 0.2s, transform 0.1s; }
    .button.save { background-color: #137fec; color: #fff; }
    .button.cancel { background-color: #6c757d; color: #fff; }
    .button.save:hover { background-color: #0f6ed4; }
    .button.cancel:hover { background-color: #5c636a; }

    .footer-nav {
      position: fixed; bottom: 0; width: 100%; max-width: 450px; left: 50%; transform: translateX(-50%);
      display: flex; justify-content: space-around; background-color: #fff; border-top: 1px solid #eee; box-shadow: 0 -1px 4px rgba(0, 0, 0, 0.05);
      z-index: 50;
    }
    .footer-nav-item { display: flex; flex-direction: column; align-items: center; padding: 8px 0; text-decoration: none; color: #6c757d; font-size: 0.7rem; flex: 1; }
    .footer-nav-item.active, .footer-nav-item:hover { color: #137fec; }
    .footer-nav-item span.material-icons { font-size: 1.4rem; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleUp { from { transform: scale(0.95); opacity: 0.8; } to { transform: scale(1); opacity: 1; } }

    .icon-text-group { display:flex; align-items:center; gap:8px; margin-bottom:5px; }
    .icon-text-group h2, .icon-text-group label { margin:0; line-height:1.2; }
  </style>

  <!-- Telegram Web App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="month-selector">
        <span class="arrow material-icons" onclick="prevMonth()">chevron_left</span>
        <h2 id="current-month-year">2025년 10월</h2>
        <span class="arrow material-icons" onclick="nextMonth()">chevron_right</span>
      </div>
    </div>

    <div id="main-content" class="schedule-list"></div>

    <div id="settings-modal">
      <div class="modal-content">
        <div class="icon-text-group">
          <span class="material-icons">wb_sunny</span>
          <label for="duty-cycle">근무 주기 (공백으로 구분)</label>
        </div>
        <input id="duty-cycle" type="text" placeholder="예: 주 주 야 야 비 비">

        <div class="icon-text-group">
          <span class="material-icons">flag</span>
          <label for="duty-base-date">기준일 (첫 번째 주간 근무일)</label>
        </div>
        <input id="duty-base-date" type="date">

        <div class="icon-text-group">
          <span class="material-icons">group</span>
          <label for="duty-users">근무자 명단 (공백으로 구분)</label>
        </div>
        <input id="duty-users" type="text" placeholder="예: 홍길동 김철수 이영희">

        <div class="modal-buttons">
          <button class="button cancel" onclick="closeSettingsModal()">닫기</button>
          <button class="button save" onclick="saveDutyCycle()">저장</button>
        </div>
      </div>
    </div>

  </div>

  <div id="toast" style="position:fixed; left:50%; transform:translateX(-50%); bottom:80px; background:#222; color:#fff; padding:8px 12px; border-radius:8px; display:none;"></div>

  <footer class="footer-nav">
    <a class="footer-nav-item" href="#" onclick="goToToday(); return false;">
      <span class="material-icons">today</span>
      <span>Today</span>
    </a>
    <a class="footer-nav-item" href="#" onclick="openSettingsModal(); return false;">
      <span class="material-icons">settings</span>
      <span>Settings</span>
    </a>
  </footer>

  <script>
    /**************************************************************************
     * 원본 하드코딩된 백엔드 URL (주석으로 보관)
     *
     * 원본 코드 예시 (보관용 주석):
     * const WORKER_API_BASE = 'https://notifier-worker-backend.annae0sang3.workers.dev/';
     *
     * 주의: 클라이언트에 직접 하드코딩하면 배포된 JS/HTML에서 URL이 노출됩니다.
     **************************************************************************/
    /*
    // 원본 보관용
    const WORKER_API_BASE = 'https://notifier-worker-backend.annae0sang3.workers.dev/';
    */

    /**************************************************************************
     * 변경(옵션 A 적용) — 클라이언트에서 직접 백엔드 URL 사용
     * - 요청대로 "옵션 A: 그대로 둔다"를 실제로 반영하였음.
     * - 원본 주석은 보관되어 있으며, 아래에 실제 사용되는 상수를 추가함.
     **************************************************************************/
    // 실제 운영용 하드코딩(옵션 A)
    const WORKER_API_BASE = 'https://notifier-worker-backend.annae0sang3.workers.dev/';

    /*****************************
     * 기존 UI / 유틸 함수들 (원본 기능 유지)
     *****************************/
    const DAYS = ['일','월','화','수','목','금','토'];
    let currentDate = new Date();

    function updateMonthHeader() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth() + 1;
      document.getElementById('current-month-year').textContent = `${year}년 ${month}월`;
    }

    function getDaysInMonth(date) {
      return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    function createDutyCard(dayNum, dayName, date, duty = { day: [], night: [] }) {
      let icon = '';
      if (duty.day.length > 0 && duty.night.length === 0) {
        icon = '<span class="material-icons duty-icon day-icon">wb_sunny</span>';
      } else if (duty.night.length > 0 && duty.day.length === 0) {
        icon = '<span class="material-icons duty-icon night-icon">nights_stay</span>';
      } else if (duty.day.length > 0 && duty.night.length > 0) {
        icon = '<span class="material-icons duty-icon mixed-icon">star_half</span>';
      }

      let dayClass = '';
      if (dayName === '토') dayClass = 'weekend-sat';
      else if (dayName === '일') dayClass = 'weekend-sun';

      let todayClass = '';
      const today = new Date();
      if (date.getDate() === today.getDate() &&
          date.getMonth() === today.getMonth() &&
          date.getFullYear() === today.getFullYear()) {
        todayClass = 'today';
      }

      const dayDuty = duty.day.join(', ') || '-';
      const nightDuty = duty.night.join(', ') || '-';

      return `
        <div class='schedule-card ${todayClass}'>
          <div class='card-date'>
            ${icon}
            <div class='day-num'>${String(dayNum).padStart(2,'0')}</div>
            <div class='day-name ${dayClass}'>${dayName}</div>
          </div>
          <div class='card-duties'>
            <div class="day-duty-col">${dayDuty}</div>
            <div class="night-duty-col">${nightDuty}</div>
          </div>
        </div>`;
    }

    function scrollToTodayCard() {
      const todayCard = document.querySelector('.schedule-card.today');
      const header = document.querySelector('.header');
      if (!todayCard) return;
      const offsetTop = todayCard.getBoundingClientRect().top + window.scrollY - (header ? header.offsetHeight : 0);
      window.scrollTo({ top: offsetTop, behavior: 'smooth' });
    }

    /**************************************************************************
     * 원본 saveDutyCycle 함수 (주석으로 보관) — 참고용
     * - 원본은 WORKER_API_BASE를 사용해 직접 백엔드 호출하는 형태였음.
     **************************************************************************/
    /*
    async function saveDutyCycle() {
      const cycle = document.getElementById('duty-cycle').value;
      const baseDate = document.getElementById('duty-base-date').value;
      const users = document.getElementById('duty-users').value.split(/\s+/).filter(Boolean);

      if (users.length === 0) {
        showToast('근무자 명단이 필요합니다.');
        return;
      }

      try {
        const response = await fetch(`${WORKER_API_BASE}api/settings`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cycle, baseDate, users })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || response.statusText || '알 수 없는 오류');
        }

        showToast('설정이 저장되었습니다.');
        closeSettingsModal();
        renderSchedule();
      } catch (e) {
        showToast('설정 저장 실패: ' + e.message);
      }
    }
    */

    /**************************************************************************
     * 현재 적용된 saveDutyCycle 함수 (옵션 A: 직접 백엔드 URL 사용)
     * - fetch가 WORKER_API_BASE + 'api/settings' 로 호출되도록 복원/구현함.
     **************************************************************************/
    async function saveDutyCycle() {
      const cycle = document.getElementById('duty-cycle').value;
      const baseDate = document.getElementById('duty-base-date').value;
      const users = document.getElementById('duty-users').value.split(/\s+/).filter(Boolean);

      if (users.length === 0) {
        showToast('근무자 명단이 필요합니다.');
        return;
      }

      try {
        const response = await fetch(`${WORKER_API_BASE}api/settings`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          // credentials 옵션은 세션/쿠키를 사용할 때만 켜라
          // credentials: 'include',
          body: JSON.stringify({ cycle, baseDate, users })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || response.statusText || '알 수 없는 오류');
        }

        showToast('설정이 저장되었습니다.');
        closeSettingsModal();
        renderSchedule();
      } catch (e) {
        showToast('설정 저장 실패: ' + e.message);
      }
    }

    /**************************************************************************
     * Telegram WebApp 초기화 및 이벤트 바인딩 (유지)
     * - tg.ready(), themeChanged, viewportChanged, MainButton 사용 포함
     * - tg.initData 사용 시 서버 검증 권장 (주석 포함)
     **************************************************************************/
    (function initTelegramIntegration() {
      const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
      if (!tg) {
        console.warn('Telegram WebApp 객체를 찾을 수 없습니다. Telegram 내에서 테스트하세요.');
        return;
      }

      tg.ready();
      window.TG = tg;

      // SECURITY NOTE: tg.initData (signed) 는 서버에서 검증 후 사용하세요.
      // 서버 검증: 클라이언트에서 initData를 서버로 보내고, 서버가 Telegram 문서 방식으로 시그니처 확인 → 세션 발급

      function applyTheme() {
        const scheme = tg.colorScheme || 'light';
        document.documentElement.setAttribute('data-theme', scheme);
      }
      applyTheme();
      tg.onEvent('themeChanged', applyTheme);

      function adjustForViewport() {
        try {
          const viewportH = tg.viewportHeight;
          const container = document.querySelector('.container');
          if (container) container.style.height = viewportH + 'px';
        } catch (e) {
          console.warn('viewport 조정 실패', e);
        }
      }
      adjustForViewport();
      tg.onEvent('viewportChanged', adjustForViewport);

      try {
        tg.MainButton.hide();
        window.onTelegramMainButtonClick = async function () {
          if (typeof saveDutyCycle === 'function') await saveDutyCycle();
        };
        tg.MainButton.onClick(window.onTelegramMainButtonClick);
      } catch (e) {
        console.warn('MainButton 초기화 실패:', e);
      }
    })();

    /**************************************************************************
     * 모달 열기/닫기: Telegram 내에서는 MainButton을 전송 버튼으로 활용
     **************************************************************************/
    function openSettingsModal() {
      document.getElementById('settings-modal').style.display = 'flex';
      if (window.TG && window.TG.MainButton) {
        window.TG.MainButton.setText('저장');
        window.TG.MainButton.show();
      }
    }
    function closeSettingsModal() {
      document.getElementById('settings-modal').style.display = 'none';
      if (window.TG && window.TG.MainButton) window.TG.MainButton.hide();
    }

    /**************************************************************************
     * renderSchedule 등 UI 로직(원본 기능 유지)
     * - 네 원본 코드에서 실제 스케줄 생성 로직을 그대로 보존하려면
     *   원본 스크립트의 세부 함수들을 보내줘. 내가 정확히 병합해줄게.
     **************************************************************************/
    function renderSchedule(scrollToTodayFlag = true) {
      updateMonthHeader();
      const main = document.getElementById('main-content');
      main.innerHTML = ''; // 기본 클리어
      const daysInMonth = getDaysInMonth(currentDate);
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month, d);
        const dayName = DAYS[date.getDay()];
        // 기본 더미 duty (원본에 따른 실제 데이터 로직으로 변경 가능)
        const duty = { day: [], night: [] };
        // 렌더 카드 추가
        main.insertAdjacentHTML('beforeend', createDutyCard(d, dayName, date, duty));
      }
      if (scrollToTodayFlag) setTimeout(scrollToTodayCard, 250);
    }

    function prevMonth() { currentDate.setMonth(currentDate.getMonth() - 1); renderSchedule(false); }
    function nextMonth() { currentDate.setMonth(currentDate.getMonth() + 1); renderSchedule(false); }

    function goToToday() {
      currentDate = new Date();
      renderSchedule(true);
    }

    document.addEventListener('DOMContentLoaded', () => {
      // 텔레그램 내 테스트 시 tg 객체 동작은 initTelegramIntegration에서 처리됨
      goToToday();
    });

  </script>
</body>
</html>
