
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>On-Call Schedule</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', 'SF Pro Display', sans-serif;
      margin: 0;
      background-color: #f6f7f8;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding-bottom: 60px;
      text-align: center;
    }
    .container {
      max-width: 450px;
      width: 100%;
      margin: 0 auto;
      flex-grow: 1;
    }
    .header {
      padding: 15px 16px 10px 16px;
      position: sticky;
      top: 0;
      background-color: #f6f7f8;
      z-index: 10;
    }
    .header h1 {
      font-size: 1.2rem;
      font-weight: 700;
      color: #101922;
      margin: 0 0 15px;
    }
    .month-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    .month-selector .arrow {
      font-size: 1.5rem;
      cursor: pointer;
      color: #6c757d;
    }
    .month-selector h2 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #101922;
      margin: 0;
      cursor: pointer; /* âš›ï¸ ì—°ì† í´ë¦­ íŠ¸ë¦¬ê±°ë¥¼ ìœ„í•´ ì»¤ì„œ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    }
    .schedule-list {
      padding: 0 16px;
      margin-bottom: 20px;
    }
    .schedule-card {
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.15);
      margin-bottom: 8px;
      padding: 8px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }    
    /* ì˜¤ëŠ˜ ë‚ ì§œ ì¹´ë“œ ê°•ì¡° */
    .schedule-card.today {
      border: 2px solid #137fec;
      box-shadow: 0 2px 8px rgba(19, 127, 236, 0.2);
    }    
    .card-date {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 70px;
      position: relative;
    }
    .day-num {
      font-weight: 500;
      font-size: 1.1rem;
      color: #101922;
    }
    .day-name {
      font-size: 0.95rem;
      color: #6c757d;
    }
    /* ì£¼ë§ ìƒ‰ìƒ */
    .day-name.weekend-sat { color: #137fec; }
    .day-name.weekend-sun { color: #dc3545; }
    /* ê·¼ë¬´ íƒ€ì… ì•„ì´ì½˜ ìœ„ì¹˜ ì¡°ì • (ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬) */
    .duty-icon {
      position: absolute;
      top: 50%; /* ìƒë‹¨ 50% ìœ„ì¹˜ */
      transform: translateY(-50%); /* ì•„ì´ì½˜ ë†’ì´ì˜ 50%ë§Œí¼ ìœ„ë¡œ ì´ë™ */
      left: -2px; /* ì¢Œì¸¡ì—ì„œ ì¡°ê¸ˆ ìš°ì¸¡ìœ¼ë¡œ ì´ë™ */
      font-size: 1.1rem;
      transition: color 0.2s;
    }
    .day-icon { left: 3px; color: #ffc107; }
    .night-icon { left: 3px; color: #4a5482; }
    .mixed-icon { left: 3px; color: #f96d00; }
    /* ë‹¹ì§ì ì—´ ì •ë ¬ */
    .card-duties {
      flex-grow: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 1px solid #eee;
      padding-left: 1px; /* ì£¼ê°„ë‹¹ì§ìë¥¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë„ìš°ê¸° */
      color: #555;
      font-size: 1.0rem;
    }
    .day-duty-col {
      flex: 4;
      text-align: center; /* ì£¼ê°„ ë‹¹ì§ì ì¤‘ì•™ ì •ë ¬ ìœ ì§€ */
      font-weight: 500;
    }
    .night-duty-col {
      flex: 6;
      text-align: center; /* ì•¼ê°„ ë‹¹ì§ìë¥¼ ì¤‘ì•™ìª½ìœ¼ë¡œ ì´ë™ */
      font-weight: 500;
    }
    /* ---------- Settings Modal / Toast / Footer ---------- */
    #settings-modal {
      display: none; position: fixed; top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.45); backdrop-filter: blur(3px);
      justify-content: center; align-items: center; z-index: 1000;
      animation: fadeIn 0.25s ease-out;
    }
    #settings-modal .modal-content {
      background: #fff; border-radius: 18px; width: 92%; max-width: 380px;
      padding: 24px 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      animation: scaleUp 0.25s ease-out; position: relative; text-align: left;
      box-sizing: border-box;
    }
    /* ... (Modal input, button styles) ... */
    #settings-modal input {
      width: calc(100% - 4px); /* ğŸ’¡ width ìˆ˜ì • (íŒ¨ë”© ê³ ë ¤) */
      box-sizing: border-box;
      padding: 9px 10px;
      font-size: 1rem;
      border-radius: 8px; /* ë©”ì¸ ë””ìì¸ê³¼ í†µì¼ì„± */
      border: 1px solid #ddd;
      background-color: #f7f8fa; /* ë°°ê²½ìƒ‰ì„ ì—°í•˜ê²Œ */
      margin-top: 20px;
      margin-bottom: 30px;
      transition: all 0.2s;
    }
    #settings-modal input:focus {
      border-color: #137fec; /* í¬ì»¤ìŠ¤ ì‹œ ê°•ì¡° ìƒ‰ìƒ */
      background-color: #fff;
      outline: none;
    }    
    .modal-buttons {
      display: flex;
      justify-content: flex-end; /* ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë°°ì¹˜ */
      gap: 10px;
      margin-top: 24px;
    }
    .button {
      border: none;
      border-radius: 8px; /* ëª¨ì„œë¦¬ í†µì¼ */
      padding: 10px 16px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }
    .button.save {
      background-color: #137fec; /* ë©”ì¸ ê°•ì¡° ìƒ‰ìƒ */
      color: #fff;
    }
    .button.cancel {
      background-color: #6c757d; /* íšŒìƒ‰ í†¤ */
      color: #fff;
    }
    /* í˜¸ë²„ íš¨ê³¼ (Mini Appì—ì„œëŠ” ì˜ ì‚¬ìš©ë˜ì§€ ì•Šì§€ë§Œ, ì›¹ë·° í‘œì¤€ì„ ìœ„í•´ ìœ ì§€) */
    .button.save:hover { background-color: #0f6ed4; }
    .button.cancel:hover { background-color: #5c636a; }
                                                                              


                                        
                                        .fab-container {
                                          position: fixed;
                                          bottom: 25px; /* í•˜ë‹¨ ì—¬ë°± */
                                          right: 25px;  /* ìš°ì¸¡ ì—¬ë°± */
                                          display: flex;
                                          flex-direction: row-reverse; /* Today ë²„íŠ¼ì´ í•­ìƒ ê°€ì¥ ì˜¤ë¥¸ìª½ì— ì˜¤ë„ë¡ */
                                          align-items: center;
                                          z-index: 900;
                                        }
                                        
                                        .fab {
                                          width: 56px;
                                          height: 56px;
                                          background-color: #137fec;
                                          color: #fff;
                                          border-radius: 50%;
                                          display: flex;
                                          align-items: center;
                                          justify-content: center;
                                          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
                                          text-decoration: none;
                                          transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
                                          cursor: pointer;
                                        }
                                        
                                        .fab.today-fab {
                                          background-color: #137fec; /* Today ë²„íŠ¼ ìƒ‰ìƒ */
                                          z-index: 902; /* í•­ìƒ ìœ„ì— ìˆë„ë¡ */
                                        }
                                        
                                        /* [ìš”ì²­ì‚¬í•­ 3] ì„¤ì • ë²„íŠ¼ ì´ˆê¸° ìˆ¨ê¹€ ë° ë…¸ì¶œ ìŠ¤íƒ€ì¼ */
                                        .fab.settings-fab {
                                          background-color: #6c757d; /* ì„¤ì • ë²„íŠ¼ ìƒ‰ìƒ */
                                          /* ì´ˆê¸° ìˆ¨ê¹€ ìƒíƒœ */
                                          width: 0;
                                          opacity: 0;
                                          padding: 0;
                                          margin-right: 0;
                                          overflow: hidden;
                                          pointer-events: none;
                                          transform: scale(0.5);
                                          z-index: 901;
                                        }
                                        
                                        .fab.settings-fab.visible {
                                          /* í™œì„±í™” ìƒíƒœ (Today ë²„íŠ¼ì„ ë°€ì–´ë‚´ë©° ë‚˜íƒ€ë‚¨) */
                                          width: 56px;
                                          opacity: 1;
                                          margin-right: 12px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
                                          pointer-events: auto;
                                          transform: scale(1);
                                        }
                                        
                                        /* [ìš”ì²­ì‚¬í•­ 6] ëª¨ë‹¬ ë²„íŠ¼ ì˜ì—­ ì¬ì •ë ¬ */
                                        .modal-buttons {
                                          display: flex;
                                          justify-content: space-between; /* ì–‘ìª½ ëìœ¼ë¡œ ì •ë ¬ */
                                          align-items: center;
                                          margin-top: 24px;
                                        }
                                        
                                        .action-buttons {
                                          display: flex;
                                          gap: 10px; /* ë‹«ê¸°/ì €ì¥ ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
                                        }
                                        
                                        /* [ìš”ì²­ì‚¬í•­ 6, 7] ë„ì›€ë§ ì•„ì´ì½˜ ë° íˆ´íŒ ìŠ¤íƒ€ì¼ */
                                        .help-container {
                                          position: relative; /* íˆ´íŒ ìœ„ì¹˜ì˜ ê¸°ì¤€ì  */
                                        }
                                        
                                        .help-icon {
                                          font-size: 1.6rem;
                                          color: #888;
                                          cursor: pointer;
                                          padding: 5px; /* í´ë¦­ ì˜ì—­ í™•ë³´ */
                                          transition: color 0.2s;
                                        }
                                        .help-icon:hover {
                                          color: #333;
                                        }
                                        
                                        .modal-tooltip {
                                          display: none; /* ì´ˆê¸° ìˆ¨ê¹€ */
                                          position: absolute;
                                          bottom: 120%; /* ì•„ì´ì½˜ ìœ„ìª½ì— í‘œì‹œ */
                                          left: -10px; /* ì•„ì´ì½˜ ëŒ€ë¹„ ì™¼ìª½ìœ¼ë¡œ ì‚´ì§ ì´ë™ */
                                          width: 280px; /* íˆ´íŒ ë„ˆë¹„ */
                                          background-color: #333;
                                          color: #fff;
                                          padding: 12px 16px;
                                          border-radius: 8px;
                                          font-size: 0.9rem;
                                          line-height: 1.5;
                                          text-align: left;
                                          box-shadow: 0 2px 8px rgba(0,0,0,0.25);
                                          z-index: 1001; /* ëª¨ë‹¬ ì»¨í…ì¸ ë³´ë‹¤ ìœ„ì— í‘œì‹œ */
                                        }
                                        
                                        .modal-tooltip p {
                                          margin: 0 0 8px 0;
                                        }
                                        .modal-tooltip p:last-child {
                                          margin-bottom: 0;
                                        }
                                        
                                        /* íˆ´íŒ ê¼¬ë¦¬í‘œ (ë§í’ì„ ì²˜ëŸ¼ ë³´ì´ë„ë¡) */
                                        .modal-tooltip::after {
                                          content: '';
                                          position: absolute;
                                          top: 100%; /* íˆ´íŒ í•˜ë‹¨ ì¤‘ì•™ */
                                          left: 20px; /* ê¼¬ë¦¬í‘œ ìœ„ì¹˜ */
                                          border-width: 6px;
                                          border-style: solid;
                                          border-color: #333 transparent transparent transparent;
                                        }
                                        
                                        .modal-tooltip.visible {
                                          display: block; /* íˆ´íŒ ë³´ì´ê¸° */
                                        }





    

   
    @keyframes fadeIn {
      from { opacity: 0; } to { opacity: 1; }
    }
    @keyframes scaleUp {
      from { transform: scale(0.95); opacity: 0.8; }
      to { transform: scale(1); opacity: 1; }
    }
    
    /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ë¥¼ ê°ì‹¸ëŠ” ê·¸ë£¹ì„ Flex ì»¨í…Œì´ë„ˆë¡œ ë§Œë“¦ */
    .icon-text-group {
      display: flex;         /* ì´ ìš”ì†Œë¥¼ Flexbox ì»¨í…Œì´ë„ˆë¡œ ì„¤ì • */
      align-items: center;   /* ìì‹ ìš”ì†Œë“¤(ì•„ì´ì½˜, í…ìŠ¤íŠ¸)ì„ ì„¸ë¡œì¶•(êµì°¨ì¶•) ì¤‘ì•™ì— ì •ë ¬ */
      gap: 8px;              /* ìì‹ ìš”ì†Œë“¤ ì‚¬ì´ì— 8pxì˜ ê°„ê²© */
      margin-bottom: 5px;    /* ë‹¤ìŒ ì…ë ¥ í•„ë“œì™€ì˜ ê°„ê²© ì¡°ì • (í•„ìš”ì‹œ) */
      /* H2ë‚˜ Labelì˜ ê¸°ë³¸ marginì´ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì´ˆê¸°í™” */
    }
    .icon-text-group h2,
    .icon-text-group label {
      margin: 0;             /* h2ì™€ labelì˜ ê¸°ë³¸ ë§ˆì§„ì„ ì—†ì• ì„œ flexbox ì •ë ¬ì— ë°©í•´ë˜ì§€ ì•Šë„ë¡ í•¨ */
      line-height: 1.2;      /* í…ìŠ¤íŠ¸ì˜ ë¼ì¸ ë†’ì´ ì¡°ì ˆ (ì·¨í–¥ì— ë”°ë¼) */
    }

    /* ì„¤ì • ì œëª© ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ê·¸ë£¹ (ì˜µì…˜) */
    .icon-text-group.header-group {
        /* í•„ìš”í•˜ë©´ ì„¤ì • ì œëª© ë¶€ë¶„ì—ë§Œ ì¶”ê°€ì ì¸ ìŠ¤íƒ€ì¼ ì ìš© ê°€ëŠ¥ */
        margin-top: 10px; /* ìƒë‹¨ ì—¬ë°± ì¶”ê°€ ë“± */
    }
                                                                            /* #access-denied {
                                                                              display: none; /* ğŸ’¥ğŸ’¥ğŸ’¥ ì´ˆê¸°ì—ëŠ” display: none;ìœ¼ë¡œ ìˆ¨ê¹€ ğŸ’¥ğŸ’¥ğŸ’¥ */
                                                                              margin-top: 50px; 
                                                                              color: #dc3545; 
                                                                              font-weight:600;
                                                                            } */
    /* ğŸ’¥ğŸ’¥ğŸ’¥ ìƒˆë¡œìš´ CSS ì¶”ê°€: ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ë˜ê¸° ì „ê¹Œì§€ ëª¨ë“  ë©”ì¸ ì½˜í…ì¸ ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤. ğŸ’¥ğŸ’¥ğŸ’¥ */
    body > *:not(#telegram-info):not(#access-denied) {
        display: none;
    }
    #telegram-info, #access-denied {
    position: fixed !important; /* í™”ë©´ì— ê³ ì • */
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;   /* ë·°í¬íŠ¸ ë„ˆë¹„ ì „ì²´ */
    height: 100vh !important;  /* ë·°í¬íŠ¸ ë†’ì´ ì „ì²´ */
    display: flex !important;  /* ë‚´ìš©ì„ ê°€ìš´ë° ì •ë ¬í•˜ê¸° ìœ„í•´ flex ì‚¬ìš© */
    justify-content: center !important; /* ìˆ˜í‰ ê°€ìš´ë° */
    align-items: center !important;     /* ìˆ˜ì§ ê°€ìš´ë° */
    background-color: rgba(255, 255, 255, 0.95) !important; /* ë°˜íˆ¬ëª… í°ìƒ‰ ë°°ê²½ìœ¼ë¡œ ë‹¤ë¥¸ UI ê°€ë¦¬ê¸° */
    z-index: 1000 !important; /* ë‹¤ë¥¸ ëª¨ë“  UI ìš”ì†Œ ìœ„ì— ì˜¤ë„ë¡ z-index ë†’ê²Œ ì„¤ì • */
    color: #333 !important;
    font-size: 1.2em !important;
    text-align: center !important;
    padding: 20px !important;
    box-sizing: border-box !important; /* íŒ¨ë”©ì´ ë„ˆë¹„/ë†’ì´ì— í¬í•¨ë˜ë„ë¡ */
    }
    
    /* ì¶”ê°€ì ìœ¼ë¡œ access-denied ë‚´ p íƒœê·¸ì— ëŒ€í•œ ìŠ¤íƒ€ì¼ë„ ì¡°ì •í•  ìˆ˜ ìˆìŒ */
    #access-denied p {
        color: #dc3545; /* ë¹¨ê°„ìƒ‰ ì˜¤ë¥˜ ë©”ì‹œì§€ */
    }
 
    #toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);        
        background-color: rgba(0, 0, 0, 0.75);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        z-index: 1000;        
        /* ğŸ’¥ğŸ’¥ğŸ’¥ ì´ ìƒíƒœë¡œ ìœ ì§€! ğŸ’¥ğŸ’¥ğŸ’¥ */
        opacity: 0;
        visibility: hidden; 
        transition: opacity 1.0s ease-in-out;         
        font-size: 1.0em;
        white-space: nowrap;
    }

    
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="month-selector">
        <span class="arrow material-icons" onclick="prevMonth()">chevron_left</span>
        <h2 id="current-month-year">2025ë…„ 10ì›”</h2>
        <span class="arrow material-icons" onclick="nextMonth()">chevron_right</span>
      </div>
    </div>


    <div id="telegram-info" style="padding: 16px; background: #eef; border-radius: 8px; margin: 16px; display: none;">
      Telegram WebApp ì •ë³´ ë¡œë”© ì¤‘...
    </div>
    
    <!-- â— ì¸ì¦ ì‹¤íŒ¨ ì‹œ ë©”ì‹œì§€ í‘œì‹œ -->
    <div id="access-denied" margin-top: 50px; color: #dc3545; font-weight:600;">
      <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ë‚´ìš© ì±„ì›€ -->
      <p>ì´ ë¯¸ë‹ˆì•±ì€ íŠ¹ì • í…”ë ˆê·¸ë¨ ë‹¨ì²´ë°© ë©¤ë²„ë§Œ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>

    <div id="main-content" class="schedule-list"></div>

    <div id="settings-modal">
      <div class="modal-content">
        <!-- <div class="icon-text-group header-group"> <
          <span class="material-icons-outlined">settings</span>
          <h2>ì„¤ì •</h2>
        </div> -->

        <!-- <span class="material-icons close-icon" onclick="closeSettingsModal()">close</span> ë‹«ê¸° ë²„íŠ¼ì€ ë”°ë¡œ ë‘  -->

        <div class="icon-text-group"> <!-- ì•„ì´ì½˜ê³¼ labelì„ ê°ìŒˆ -->
          <span class="material-icons">wb_sunny</span>
          <label for="duty-cycle">ê·¼ë¬´ ì£¼ê¸° (ê³µë°±ìœ¼ë¡œ êµ¬ë¶„)</label>
        </div>
        <input id="duty-cycle" type="text" placeholder="ì˜ˆ: ì£¼ ì£¼ ì•¼ ì•¼ ë¹„ ë¹„">

        <div class="icon-text-group"> <!-- ì•„ì´ì½˜ê³¼ labelì„ ê°ìŒˆ -->
          <span class="material-icons">flag</span>
          <label for="duty-base-date">ê¸°ì¤€ì¼ (ì²« ë²ˆì§¸ ì£¼ê°„ ê·¼ë¬´ì¼)</label>
        </div>
        <input id="duty-base-date" type="date">

        <div class="icon-text-group"> <!-- ì•„ì´ì½˜ê³¼ labelì„ ê°ìŒˆ -->
          <span class="material-icons">group</span>
          <label for="duty-users">ê·¼ë¬´ì ëª…ë‹¨ (ê³µë°±ìœ¼ë¡œ êµ¬ë¶„)</label>
        </div>
        <input id="duty-users" type="text" placeholder="ì˜ˆ: í™ê¸¸ë™ ê¹€ì² ìˆ˜ ì´ì˜í¬">

        <div class="modal-buttons">
            <div class="help-container">
              <span id="help-tooltip-trigger" class="material-icons help-icon" onclick="toggleHelpTooltip()">help_outline</span>
              
              <div id="help-tooltip" class="modal-tooltip">
                <p>1. ê¸°ì¤€ì¼ì€ ê·¼ë¬´ì£¼ê¸°ì˜ ì²« ë‚ (ì£¼)ë¡œ ì„¤ì •í•  ê²ƒ.</p>
                <p>2. ê¸°ì¤€ì¼ë¶€í„° ê·¼ë¬´ì ëª…ë‹¨ ìˆœì„œë¡œ ë‹¹ì§ ë°°ì • ë¨.</p>
                <p>3. ê·¼ë¬´ìê°€ í™€ìˆ˜ì¼ ê²½ìš°ì—ëŠ” 123123 ìˆœì„œ,
                      ì§ìˆ˜ì¼ ê²½ìš°ì—ëŠ” 12342143 ìˆœì„œë¡œ ë°˜ë³µë¨.</p>
              </div>
            </div>
            
            <div class="action-buttons">
              <button class="button cancel" onclick="closeSettingsModal()">ë‹«ê¸°</button>
              <button class="button save" onclick="saveDutyCycle()">ì €ì¥</button>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast"></div>

                                                                 


                          <div class="fab-container">
                            <a id="fab-today" class="fab today-fab" href="#" onclick="goToToday(); return false;">
                              <span class="material-icons">today</span>
                            </a>
                            <a id="fab-settings" class="fab settings-fab" href="#" onclick="openSettingsModal(); return false;">
                              <span class="material-icons">settings</span>
                            </a>                            
                          </div>



  
  <script>
      const DAYS = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ']; 
      let currentDate = new Date(); 
      const WORKER_API_BASE = 'https://notifier-worker-backend.annae0sang3.workers.dev';

      // =========================================================================
      // âœ… í…”ë ˆê·¸ë¨ WebApp ë° ì‚¬ìš©ì ê²€ì¦ ë¡œì§ (URL íŒŒë¼ë¯¸í„° ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½)
      // =========================================================================
      let currentUserId = null; // ğŸ’¥ ê²€ì¦ëœ ì‚¬ìš©ì IDë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
      let currentChatId = null; // ğŸ’¥ í˜„ì¬ ë¯¸ë‹ˆì•±ì´ ì—´ë¦° ì±„íŒ…ë°© ID ì €ì¥í•  ì „ì—­ ë³€ìˆ˜

      document.addEventListener('DOMContentLoaded', async () => {
          console.log("DEBUG: DOMContentLoaded Start"); // âœ… ì´ ë¡œê·¸ê°€ ì½˜ì†”ì— ì°íˆëŠ”ì§€ í™•ì¸
          const headerElement = document.querySelector('.header');
          const mainContentElement = document.getElementById('main-content');
          const fabContainer = document.querySelector('.fab-container');                                                                                   
          const telegramInfoDiv = document.getElementById('telegram-info');
          const accessDeniedDiv = document.getElementById('access-denied');
          // ì´ˆê¸° UI ìˆ¨ê¸°ê¸°
          headerElement.style.display = 'none';
          mainContentElement.style.display = 'none';
          fabContainer.style.display = 'none';                                                                                            
          telegramInfoDiv.style.display = 'block'; // ğŸš¨ ì´ˆê¸°ì—ëŠ” 'ì •ë³´ ë¡œë”© ì¤‘...' ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤„ ê²ƒì´ë¯€ë¡œ 'block'ìœ¼ë¡œ ì‹œì‘
          telegramInfoDiv.textContent = 'Telegram WebApp ì •ë³´ ë¡œë”© ì¤‘...'; // ë¡œë”© í…ìŠ¤íŠ¸ ì„¤ì •
          // í…”ë ˆê·¸ë¨ WebApp ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì—¬ë¶€ ë° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if (typeof Telegram === 'undefined' || !window.Telegram.WebApp) {
            console.log('âŒ í…”ë ˆê·¸ë¨ ë¯¸ë‹ˆì•± í™˜ê²½ì´ ì•„ë‹™ë‹ˆë‹¤. ì¼ë°˜ ì›¹í˜ì´ì§€ë¡œ ì—´ë ¸ìŠµë‹ˆë‹¤.');
            accessDeniedDiv.querySelector('p').textContent = 'ì´ ì•±ì€ í…”ë ˆê·¸ë¨ ë¯¸ë‹ˆì•± í™˜ê²½ì—ì„œë§Œ ë™ì‘í•©ë‹ˆë‹¤.';
            accessDeniedDiv.style.display = 'block'; // ì ‘ê·¼ ê±°ë¶€ ë©”ì‹œì§€ í™œì„±í™”
            telegramInfoDiv.style.display = 'none'; // ì—ëŸ¬ ì‹œ ì •ë³´ ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
            return;
          }
          // í…”ë ˆê·¸ë¨ WebApp ì¤€ë¹„ ì™„ë£Œ ì•Œë¦¼
          console.log("DEBUG: Telegram WebApp is ready to proceed.");
                                                                      // window.Telegram.WebApp.ready();           
                                                                      // // ğŸ’¥ğŸ’¥ğŸ’¥ URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ user_id, chat_id, sigë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤! ğŸ’¥ğŸ’¥ğŸ’¥
                                                                      // const urlParams = new URLSearchParams(window.location.search);
                                                                      // const userId = urlParams.get('user_id');
                                                                      // const chatId = urlParams.get('chat_id');
                                                                      // const signature = urlParams.get('sig'); // ë³´ì•ˆ ì„œëª…
                                                                      // console.log(`DEBUG_PARAMS: userId=${userId}, chatId=${chatId}, signature=${signature}`);
                                                      // let currentUserId = null;
                                                      // let currentChatId = null;
          const tg = window.Telegram.WebApp;
          const initData = tg.initData; // í…”ë ˆê·¸ë¨ì´ ìë™ìœ¼ë¡œ ë¶™ì—¬ì£¼ëŠ” ê²€ì¦ìš© ë°ì´í„° (ì•ˆì „í•œ ë°ì´í„°)
        
          // // ğŸ’¥ğŸ’¥ğŸ’¥ ì„ì‹œë¡œ ì´ ì½”ë“œë¥¼ ì¶”ê°€í•´ì„œ initDataë¥¼ í™”ë©´ì— ì§ì ‘ í‘œì‹œí•©ë‹ˆë‹¤. ğŸ’¥ğŸ’¥ğŸ’¥
          // const debugDiv = document.createElement('div');
          // debugDiv.style.position = 'fixed';
          // debugDiv.style.bottom = '10px';
          // debugDiv.style.left = '10px';
          // debugDiv.style.right = '10px';
          // debugDiv.style.backgroundColor = 'rgba(0,0,0,0.8)';
          // debugDiv.style.color = 'white';
          // debugDiv.style.padding = '5px';
          // debugDiv.style.fontSize = '0.7em';
          // debugDiv.style.zIndex = '99999';
          // debugDiv.style.wordBreak = 'break-all';
          // debugDiv.textContent = `Full InitData: ${initData || 'Not Available'}`;
          // document.body.appendChild(debugDiv);
          // // ğŸ’¥ğŸ’¥ğŸ’¥ ì—¬ê¸°ê¹Œì§€ ì¶”ê°€ ğŸ’¥ğŸ’¥ğŸ’¥
        
          console.log("DEBUG_FULL_INITDATA_FROM_FRONTEND:", initData); // ğŸ’¥ğŸ’¥ğŸ’¥ ì´ ì¤„ì„ ì¶”ê°€!
          console.log("initData:", tg.initData);
          console.log("initDataUnsafe:", tg.initDataUnsafe);        
          //console.log(`DEBUG_PAGES_FETCH_URL: ${WORKER_API_BASE}/verify_params`);

                                                                      // if (!userId || !chatId || !signature) {
                                                                      //     console.error('âŒ URL íŒŒë¼ë¯¸í„°ì— user_id, chat_id ë˜ëŠ” sigê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                                                                      //     accessDeniedDiv.querySelector('p').textContent = 'ì—ëŸ¬: í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì–´ ì¸ì¦í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                                                                      //     accessDeniedDiv.style.display = 'block'; // ì ‘ê·¼ ê±°ë¶€ ë©”ì‹œì§€ í™œì„±í™”
                                                                      //     return;
                                                                      // }
                                                                      // console.log(`URL Params from Frontend: userId=${userId}, chatId=${chatId}, signature=${signature}`);
          if (!initData) {
            console.error('âŒ í…”ë ˆê·¸ë¨ initDataê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ë¯¸ë‹ˆì•± í™˜ê²½ì´ ì•„ë‹ˆê±°ë‚˜ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            accessDeniedDiv.querySelector('p').textContent = 'ì—ëŸ¬: í…”ë ˆê·¸ë¨ ì¸ì¦ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';
            accessDeniedDiv.style.display = 'block'; // ì ‘ê·¼ ê±°ë¶€ ë©”ì‹œì§€ í™œì„±í™”
            telegramInfoDiv.style.display = 'none'; // ì—ëŸ¬ ì‹œ ì •ë³´ ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
            return; // initData ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ì¤‘ë‹¨
          }
          try {
              // ğŸ’¥ğŸ’¥ğŸ’¥ Pagesì—ì„œ Workersë¡œ ì „ì†¡í•  JSON ë°”ë””ë¥¼ ë¯¸ë¦¬ ì°ì–´ë´…ë‹ˆë‹¤. ğŸ’¥ğŸ’¥ğŸ’¥
              const bodyToSend = JSON.stringify({ initData: initData }); // initData ì „ì²´ ë¬¸ìì—´ì„ ë°±ì—”ë“œë¡œ ì „ì†¡
                                                                                // const bodyToSend = JSON.stringify({ userId, chatId, signature });
              console.log("DEBUG_PAGES_BODY_TO_SEND:", bodyToSend); 
              console.log("DEBUG_PAGES_FETCH_URL:", `${WORKER_API_BASE}/verify_initdata`); // ğŸš¨ ì—”ë“œí¬ì¸íŠ¸ëª…ì„ /verify_initdataë¡œ ë³€ê²½
                                                                                // console.log("DEBUG_PAGES_FETCH_URL:", `${WORKER_API_BASE}/verify_params`);
                                                                                // const response = await fetch(`${WORKER_API_BASE}/verify_params`, { 
                                                                                //     method: 'POST',
                                                                                //     headers: { 'Content-Type': 'application/json' },
                                                                                //     body: JSON.stringify({ userId, chatId, signature }), 
                                                                                // });
              const response = await fetch(`${WORKER_API_BASE}/verify_initdata`, { // ğŸš¨ ì—”ë“œí¬ì¸íŠ¸ëª… ë³€ê²½
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: initData }), // initData ì „ì²´ë¥¼ ë°”ë””ë¡œ ë³´ëƒ„
              });
              const verificationResult = await response.json();

              if (verificationResult.ok) {       // âœ… ê²€ì¦ ì„±ê³µ ì‹œ                  
                  const user = verificationResult.user || {}; // ë°±ì—”ë“œì—ì„œ íŒŒì‹±ëœ user ê°ì²´
                  currentUserId = user.id; // // ë°±ì—”ë“œì—ì„œ ê²€ì¦ëœ user.id ì‚¬ìš©
                  currentChatId = verificationResult.chat_id; // ë°±ì—”ë“œì—ì„œ ê²€ì¦ëœ chat_id ì‚¬ìš© (ê·¸ë£¹ì¸ ê²½ìš°)
                                                                                // currentChatId = chatId; // ğŸ’¥ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                  console.log(`âœ“ ì¸ì¦ ì™„ë£Œ! ì‚¬ìš©ì ID: ${currentUserId}, ê·¸ë£¹ ID: ${currentChatId}`);
                                                                                // console.log(`âœ“ ì¸ì¦ ì™„ë£Œ! ì‚¬ìš©ì ID: ${userId}, ê·¸ë£¹ ID: ${chatId}`);  
                  const initDataParams = new URLSearchParams(initData);
                  let startParamValue = null;
                  if (initDataParams.has('start_param')) {
                    startParamValue = decodeURIComponent(initDataParams.get('start_param'));
                    console.log(`âœ… ê²€ì¦ëœ start_param: ${startParamValue}`);
                    // ì—¬ê¸°ì„œ startParamValue ('from_schedule_<chatId>' í˜•ì‹)ë¥¼ ì‚¬ìš©í•´ì„œ
                    // ë¯¸ë‹ˆì•± ë‚´ë¶€ ë¡œì§ì„ ì¡°ì ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    // ì˜ˆ: startParamValueì—ì„œ `<chatId>` ë¶€ë¶„ì„ ì¶”ì¶œí•˜ì—¬ íŠ¹ì • ê·¸ë£¹ì˜ ìŠ¤ì¼€ì¤„ì„ ë³´ì—¬ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    const parsedChatIdFromStartParam = startParamValue.split('_')[2];
                    if (parsedChatIdFromStartParam && parsedChatIdFromStartParam !== currentChatId) {
                        console.warn(`ì£¼ì˜: startParamì˜ chatId(${parsedChatIdFromStartParam})ì™€
                                      ê²€ì¦ëœ initDataì˜ chatId(${currentChatId})ê°€ ë‹¤ë¦…ë‹ˆë‹¤.
                                      ë³´ì•ˆìƒ initDataì˜ chatIdë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.`);
                        // ì‹¤ì œ ìƒí™©ì— ë”°ë¼ ì–´ë–¤ chat IDë¥¼ ìš°ì„ í• ì§€ ê²°ì •í•´ì•¼ í•©ë‹ˆë‹¤.
                        // ì¼ë°˜ì ìœ¼ë¡œ initDataì— ìˆëŠ” ê°’ì´ ë” ì‹ ë¢°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        }
                    }
    
                  accessDeniedDiv.style.display = 'none'; // ì ‘ê·¼ ê±°ë¶€ ë©”ì‹œì§€ëŠ” ìˆ¨ê¹€ (í˜¹ì‹œ ì´ˆê¸° display:block ì„¤ì •ë˜ì–´ ìˆì„ ê²½ìš° ëŒ€ë¹„)
                  telegramInfoDiv.style.display = 'none'; // ì •ë³´ ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
                  // âœ… ê²€ì¦ í†µê³¼ í›„ ë¯¸ë‹ˆì•±ì˜ ì£¼ìš” UI ìš”ì†Œë“¤ì„ ë³´ì´ê²Œ í•¨
                  headerElement.style.display = 'block';
                  mainContentElement.style.display = 'block';
                  fabContainer.style.display = 'flex'; // í”Œë¡œíŒ… ì•¡ì…˜ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
                  tg.ready(); // í…”ë ˆê·¸ë¨ ì›¹ì•± ì¤€ë¹„ ì™„ë£Œë¥¼ í…”ë ˆê·¸ë¨ì— ì•Œë¦¼
                  goToToday(); // ì˜¤ëŠ˜ ë‚ ì§œ ìŠ¤ì¼€ì¤„ ë¡œë“œ ì‹œì‘
              } else { // âŒ ê²€ì¦ ì‹¤íŒ¨ ì‹œ
                  console.error('âŒ ì‚¬ìš©ì ê²€ì¦ ì‹¤íŒ¨:', verificationResult.reason);
                  accessDeniedDiv.querySelector('p').textContent = `ğŸš¨ ì¸ì¦ ì‹¤íŒ¨: ${verificationResult.reason}`;
                  accessDeniedDiv.style.display = 'block'; // ì ‘ê·¼ ê±°ë¶€ ë©”ì‹œì§€ í™œì„±í™”                  
                  telegramInfoDiv.style.display = 'none'; // ì—ëŸ¬ ì‹œ ì •ë³´ ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
                  // window.Telegram.WebApp.close();   // í…”ë ˆê·¸ë¨ Web App ë‹«ê¸° (ì„ íƒ ì‚¬í•­)
              }
          } catch (error) {
              console.error('âŒ ì‚¬ìš©ì ê²€ì¦ ì¤‘ í†µì‹  ì˜¤ë¥˜:', error);
              accessDeniedDiv.querySelector('p').textContent = `ğŸš¨ ì¸ì¦ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
              accessDeniedDiv.style.display = 'block';
              telegramInfoDiv.style.display = 'none'; // ì—ëŸ¬ ì‹œ ì •ë³´ ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
              headerElement.style.display = 'none';
              mainContentElement.style.display = 'none';
              fabContainer.style.display = 'none';
              // window.Telegram.WebApp.close();
          }
       
          // ğŸ”‘ [START] ì„¤ì • ë²„íŠ¼ í† ê¸€ íŠ¸ë¦¬ê±° ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (DOMì´ ë¡œë“œëœ í›„)
          const currentMonthYearElement = document.getElementById('current-month-year');
          if (currentMonthYearElement) {
              let clickCount = 0;
              let timer = null;
              const requiredClicks = 5;
              const resetTime = 1000;
              
              currentMonthYearElement.addEventListener('click', () => {
                  clickCount++;
                  if (timer) { clearTimeout(timer); }

                  if (clickCount >= requiredClicks) {
                      toggleSettingsVisibility(); // ğŸ’¾ ì •ì˜ëœ í•¨ìˆ˜ í˜¸ì¶œ
                      clickCount = 0;
                      clearTimeout(timer);
                      timer = null;
                      console.log("Secret settings visibility toggled!");
                      return;
                  }

                  timer = setTimeout(() => {
                      if (clickCount > 0) {
                          clickCount = 0;
                          console.log("Click sequence reset.");
                      }
                  }, resetTime);
              });
          }
          // ğŸ”‘ [END] ì„¤ì • ë²„íŠ¼ í† ê¸€ íŠ¸ë¦¬ê±° ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      });

                                                                              
                                                                                   

                                  
                                  // ğŸ’¾ [START] ì„¤ì • í† ê¸€ í•¨ìˆ˜ ì •ì˜
                                  function toggleSettingsVisibility() {
                                   
                                    const settingsFab = document.getElementById('fab-settings');
                                    settingsFab.classList.toggle('visible');
                                  
                                    // [ìš”ì²­ì‚¬í•­ 4] ë²„íŠ¼ì´ 'ë³´ì´ê²Œ' ë  ë•Œë§Œ ì™¸ë¶€ í´ë¦­ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€
                                    if (settingsFab.classList.contains('visible')) {
                                      // setTimeoutì„ 0ìœ¼ë¡œ ì£¼ì–´, í˜„ì¬ í´ë¦­ ì´ë²¤íŠ¸ê°€ ë¨¼ì € ì™„ë£Œëœ í›„ ë¦¬ìŠ¤ë„ˆë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.
                                      setTimeout(() => {
                                        document.addEventListener('click', hideSettingsOnClickOutside);
                                      }, 0);
                                    } else {
                                      // ë²„íŠ¼ì´ 'ìˆ¨ê²¨ì§ˆ' ë•ŒëŠ” ë¦¬ìŠ¤ë„ˆë¥¼ ì¦‰ì‹œ ì œê±°í•©ë‹ˆë‹¤.
                                      document.removeEventListener('click', hideSettingsOnClickOutside);
                                    }
                                  }
                                  // ğŸ’¾ [END] ì„¤ì • í† ê¸€ í•¨ìˆ˜ ì •ì˜

                  
      // ì›”/ë…„ í—¤ë”ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
      function updateMonthHeader() {
          const options = { year: 'numeric', month: 'long' };
          document.getElementById('current-month-year').textContent = currentDate.toLocaleString('ko-KR', options);
      }
      // ì›” ë³€ê²½ (ì´ì „ ë‹¬)
      function prevMonth() {
          currentDate.setMonth(currentDate.getMonth() - 1);
          renderSchedule();
          showToast(`${currentDate.getFullYear()}ë…„ ${currentDate.getMonth() + 1}ì›”`);
      }
      // ì›” ë³€ê²½ (ë‹¤ìŒ ë‹¬)
      function nextMonth() {
          currentDate.setMonth(currentDate.getMonth() + 1);
          renderSchedule();
          showToast(`${currentDate.getFullYear()}ë…„ ${currentDate.getMonth() + 1}ì›”`);
      }
      // ì›”ì˜ ë§ˆì§€ë§‰ ë‚ ì§œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
      function getDaysInMonth(date) {
          return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
      }



                                
                                function toggleHelpTooltip() {
                                  const tooltip = document.getElementById('help-tooltip');
                                  tooltip.classList.toggle('visible');
                                }
                                
                                // [ìš”ì²­ì‚¬í•­ 4] ì„¤ì • ë²„íŠ¼ ì™¸ ì˜ì—­ í´ë¦­ ì‹œ ë²„íŠ¼ ìˆ¨ê¹€ ì²˜ë¦¬ í•¨ìˆ˜
                                function hideSettingsOnClickOutside(event) {
                                    const settingsFab = document.getElementById('fab-settings');
                                    const monthYearHeader = document.getElementById('current-month-year'); // íŠ¸ë¦¬ê±° ì˜ì—­
                                
                                    // í´ë¦­í•œ ëŒ€ìƒì´ ì„¤ì • ë²„íŠ¼(fab-settings) ë˜ëŠ” íŠ¸ë¦¬ê±°(current-month-year)ê°€ ì•„ë‹ˆë¼ë©´
                                    if (!settingsFab.contains(event.target) && !monthYearHeader.contains(event.target)) {
                                        if (settingsFab.classList.contains('visible')) {
                                            settingsFab.classList.remove('visible');
                                            document.removeEventListener('click', hideSettingsOnClickOutside); // ë¦¬ìŠ¤ë„ˆ ì œê±°
                                        }
                                    }
                                }

    
    
      // ì˜¤ëŠ˜ì˜ ë‚ ì§œ ì¹´ë“œì— ìŠ¤í¬ë¡¤í•©ë‹ˆë‹¤.
      function scrollToTodayCard() {
        const todayCard = document.querySelector('.schedule-card.today');
        const header = document.querySelector('.header');
      
        if (!todayCard) return; // ì˜¤ëŠ˜ ì¹´ë“œê°€ ì—†ìœ¼ë©´ ì•„ë¬´ ë™ì‘ ì•ˆ í•¨
      
        // í˜„ì¬ ì¹´ë“œì˜ ìœ„ì¹˜ ì •ë³´
        const cardRect = todayCard.getBoundingClientRect(); // ì¹´ë“œì˜ í™”ë©´ ë‚´ ìƒëŒ€ ìœ„ì¹˜
        const scrollY = window.scrollY || window.pageYOffset; // í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜
      
        // ì¤‘ì•™ì— ì¹´ë“œê°€ ì˜¤ë„ë¡ ëª©í‘œ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ê³„ì‚°
        const viewportHeight = window.innerHeight;
        const headerHeight = header ? header.offsetHeight : 0;
        const targetScrollY =
          scrollY +
          cardRect.top -
          (viewportHeight / 3 - todayCard.offsetHeight / 2) - // ì¹´ë“œ ì¤‘ì•™ì„ í™”ë©´ 1/3 ì§€ì ì— ë§ì¶¤
          headerHeight / 2; // í—¤ë” ë†’ì´ ë³´ì • (í—¤ë”ê°€ ìˆìœ¼ë©´ ë” ì‚´ì§ ìœ„ë¡œ)
      
        // ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤ ì´ë™
        window.scrollTo({
          top: targetScrollY,
          behavior: 'smooth'
        });
      }

      // ìŠ¤ì¼€ì¤„ ì¹´ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ğŸ’¥ ë°±ì—”ë“œ ì‘ë‹µ í˜•ì‹ì— ë§ì¶° item.day, item.night1, item.night2ë¡œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
      function createDutyCard(dayNum, dayName, dateObj, dutyData = null) {
        const today = new Date();
        const isToday = dateObj.getDate() === today.getDate() &&
                        dateObj.getMonth() === today.getMonth() &&
                        dateObj.getFullYear() === today.getFullYear();

        const isSaturday = dateObj.getDay() === 6;
        const isSunday = dateObj.getDay() === 0;

        let cardHtml = `<div class="schedule-card${isToday ? ' today' : ''}">`;
        
        // ì•„ì´ì½˜ ê²°ì •ì„ ìœ„í•œ ë³€ìˆ˜ ì´ˆê¸°í™”
        let dutyIconHtml = ''; // ğŸ’¥ ë‚ ì§œ ì˜†ì— í‘œì‹œë  ì•„ì´ì½˜ HTML
        if (dutyData && dutyData.type) {
            if (dutyData.type === 'ì£¼') {
                dutyIconHtml = `<span class="material-icons duty-icon day-icon">wb_sunny</span>`;
            } else if (dutyData.type === 'ì•¼') {
                dutyIconHtml = `<span class="material-icons duty-icon night-icon">nights_stay</span>`;
            }
        }


        // ğŸ’¥ğŸ’¥ğŸ’¥ ë‚ ì§œ ì˜ì—­ HTML êµ¬ì¡° ë³€ê²½: ì•„ì´ì½˜ì„ card-date ì•ˆì— ë‚ ì§œë³´ë‹¤ ë¨¼ì € ìœ„ì¹˜ì‹œí‚µë‹ˆë‹¤. ğŸ’¥ğŸ’¥ğŸ’¥
        cardHtml += `
            <div class="card-date">
                ${dutyIconHtml} <!-- ğŸ’¥ ì•„ì´ì½˜ì€ ì—¬ê¸°ì— ìœ„ì¹˜! ğŸ’¥ -->
                <span class="day-num">${dayNum}</span>
                <span class="day-name${isSaturday ? ' weekend-sat' : isSunday ? ' weekend-sun' : ''}">${dayName}</span>
            </div>
        `;

        // ğŸ’¥ğŸ’¥ğŸ’¥ ìŠ¤ì¼€ì¤„ ë°ì´í„° ì²˜ë¦¬ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ ğŸ’¥ğŸ’¥ğŸ’¥
        if (dutyData && (dutyData.day || dutyData.night1 || dutyData.night2)) {
            cardHtml += `
                <div class="card-duties">
                    <!-- ì£¼ê°„ ê·¼ë¬´ì ì˜ì—­ -->
                    <div class="duty-col day-duty-col">
                        ${dutyData.day ? `
                            <span>${dutyData.day}</span>
                        ` : ''}
                    </div>
                    <!-- ì•¼ê°„ ê·¼ë¬´ì ì˜ì—­ -->
                    <div class="duty-col night-duty-col">
                        ${(dutyData.night1 || dutyData.night2) ? `
                            <span>
                                ${dutyData.night1 || ''} 
                                ${ (dutyData.night1 && dutyData.night2) ? `ã€€` : '' } 
                                ${dutyData.night2 || ''}
                            </span>
                        ` : ''}
                    </div>
                </div>
            `;
        } else {
            cardHtml += `
                <div class="card-duties" style="text-align: center;">
                    <span style="color: #aaa;">${dutyData && dutyData.type === 'ë¹„' ? ' ' : 'ìŠ¤ì¼€ì¤„ ì—†ìŒ'}</span>
                </div>
            `;
        }
        cardHtml += `</div>`;
        return cardHtml;
      }

      // ìŠ¤ì¼€ì¤„ì„ ë Œë”ë§í•˜ê³ , í•„ìš” ì‹œ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ìŠ¤í¬ë¡¤í•©ë‹ˆë‹¤.
      // ğŸ’¥ currentUserIdì™€ currentChatIdë¥¼ ì‚¬ìš©í•˜ì—¬ ë°±ì—”ë“œ ìš”ì²­ ì‹œ í™œìš©í•©ë‹ˆë‹¤.
      // @param {boolean} [scrollToToday=false] ë Œë”ë§ í›„ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ìŠ¤í¬ë¡¤í• ì§€ ì—¬ë¶€
      async function renderSchedule(scrollToToday = false) { 
          // ğŸ’¥ ê²€ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì IDë¼ë©´ ìŠ¤ì¼€ì¤„ ë¡œë“œë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.
          if (!currentUserId || !currentChatId) { // user ID ë˜ëŠ” chat IDê°€ ì—†ìœ¼ë©´ ìŠ¤ì¼€ì¤„ ë¡œë“œ ì¤‘ë‹¨
              console.warn('ì‚¬ìš©ì/ì±„íŒ…ë°© IDê°€ ì—†ì–´ ìŠ¤ì¼€ì¤„ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              document.getElementById('main-content').innerHTML = `
                  <p style="text-align: center; color: #dc3545; margin-top: 50px;">
                      ì‚¬ìš©ì/ì±„íŒ…ë°© ì¸ì¦ì´ í•„ìš”í•˜ê±°ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
                  </p>
              `;
              return;
          }

          updateMonthHeader();
          const el = document.getElementById('main-content');
          el.innerHTML = '';
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth() + 1;
          const start = `${year}-${String(month).padStart(2,'0')}-01`;
          const end = `${year}-${String(month).padStart(2,'0')}-${String(getDaysInMonth(currentDate)).padStart(2,'0')}`;

          try {
              const res = await fetch(`${WORKER_API_BASE}/api/schedule?start=${start}&end=${end}`, {
                  // ë°±ì—”ë“œì—ì„œ ì‚¬ìš©ìë³„ ìŠ¤ì¼€ì¤„ ë¡œì§ì´ í•„ìš”í•œ ê²½ìš°, userIdì™€ chatIdë¥¼ í—¤ë”ë¡œ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                  headers: { 'X-User-Id': currentUserId, 'X-Chat-Id': currentChatId } 
              });            
              // ğŸ’¥ğŸ’¥ğŸ’¥ ìŠ¤ì¼€ì¤„ ë¡œë”© ë””ë²„ê¹… ë¡œê·¸ ğŸ’¥ğŸ’¥ğŸ’¥
              const rawResponseText = await res.text();
              console.log("DEBUG_SCHEDULE_RAW_RESPONSE:", rawResponseText);
              if (!res.ok) {
                  let errorMessage = 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜';
                  try {
                      const errorData = JSON.parse(rawResponseText);
                      errorMessage = errorData.error || errorData.reason || errorMessage;
                  } catch (e) { /* JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê·¸ëƒ¥ í…ìŠ¤íŠ¸ ì‚¬ìš© */ }
                  throw new Error(errorMessage);
              }
              const data = JSON.parse(rawResponseText); // rawResponseTextë¥¼ JSONìœ¼ë¡œ íŒŒì‹±
              console.log("DEBUG_SCHEDULE_PARSED_DATA:", data); // íŒŒì‹±ëœ ë°ì´í„° í™•ì¸
              if (!Array.isArray(data)) {
                  throw new Error(data.error || 'ì˜ˆìƒì¹˜ ëª»í•œ ë°ì´í„° í˜•ì‹: ë°°ì—´ì´ ì•„ë‹˜');
              }
              // ë Œë”ë§
              if (data.length > 0) {
                  el.innerHTML = data.map(item => {
                      const d = new Date(item.date); 
                      // ë°±ì—”ë“œ /api/schedule ì‘ë‹µ êµ¬ì¡°ì— ë§ì¶° item.day, item.night1, item.night2 ì…ë‹ˆë‹¤.
                      const dutyDisplayData = {
                          day: item.day,
                          night1: item.night1,
                          night2: item.night2,
                          type: item.type // 'ì£¼' 'ì•¼' 'ë¹„' êµ¬ë¶„ì„ ìœ„í•´ typeë„ ì „ë‹¬
                      };
                      return createDutyCard(d.getDate(), DAYS[d.getDay()], d, dutyDisplayData);
                  }).join('');
              } else {
                  el.innerHTML = `<p style="text-align: center; margin-top: 50px;">í•´ë‹¹ ì›”ì˜ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
              }
              
              if (scrollToToday) {
                  scrollToTodayCard();
              }
          } catch (error) { 
              console.error('ìŠ¤ì¼€ì¤„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);              
              const days = getDaysInMonth(currentDate);
              let fallbackHtml = '';
              for (let i = 1; i <= days; i++) {
                  const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                  // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ëŠ” dutyDataë¥¼ nullë¡œ ì „ë‹¬í•˜ì—¬ 'ìŠ¤ì¼€ì¤„ ì—†ìŒ' í‘œì‹œ
                  fallbackHtml += createDutyCard(i, DAYS[date.getDay()], date, null); 
              }
              el.innerHTML = fallbackHtml; 
              showToast(`ìŠ¤ì¼€ì¤„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (${error.message || "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜"})`);
          }
      }

      // 'ì˜¤ëŠ˜' ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ í•¨ìˆ˜
      function goToToday() {
          currentDate = new Date(); 
          renderSchedule(true); // ìŠ¤í¬ë¡¤ í”Œë˜ê·¸ë¥¼ trueë¡œ ì „ë‹¬
          showToast(`${currentDate.getFullYear()}ë…„ ${currentDate.getMonth() + 1}ì›”`);
      }

      async function openSettingsModal() {
        document.getElementById('settings-modal').style.display = 'flex';
        try {
            const res = await fetch(`${WORKER_API_BASE}/api/settings`);
            const settings = await res.json();
            if (settings.cycle) {
                document.getElementById('duty-cycle').value = settings.cycle;
            }
            if (settings.baseDate) {
                document.getElementById('duty-base-date').value = settings.baseDate.substring(0, 10);
            }
            if (settings.users && Array.isArray(settings.users)) {
                document.getElementById('duty-users').value = settings.users.join(' ');
            }
        } catch (e) {
            console.error('Failed to load settings:', e);
            showToast('Failed to load settings.');
        }
      }
                                                                              
                                                                                   



                                          
                                          
                                          function closeSettingsModal() {
                                            document.getElementById('settings-modal').style.display = 'none';
                                            
                                           
                                          
                                            // â†“â†“â†“ [ìš”ì²­ì‚¬í•­ 5] ìƒˆ ë¡œì§ ì¶”ê°€ â†“â†“â†“
                                            const settingsFab = document.getElementById('fab-settings');
                                            if (settingsFab.classList.contains('visible')) {
                                              settingsFab.classList.remove('visible');
                                            }
                                            // [ìš”ì²­ì‚¬í•­ 4] ëª¨ë‹¬ ë‹«í ë•Œ ì™¸ë¶€ í´ë¦­ ë¦¬ìŠ¤ë„ˆë„ í™•ì‹¤íˆ ì œê±°
                                            document.removeEventListener('click', hideSettingsOnClickOutside);
                                          
                                            // [ìš”ì²­ì‚¬í•­ 7] ëª¨ë‹¬ ë‹«í ë•Œ íˆ´íŒë„ ìˆ¨ê¹€
                                            const tooltip = document.getElementById('help-tooltip');
                                            if (tooltip.classList.contains('visible')) {
                                              tooltip.classList.remove('visible');
                                            }
                                          }

    
      async function saveDutyCycle() {
        const dutyCycle = document.getElementById('duty-cycle').value;
        const dutyBaseDate = document.getElementById('duty-base-date').value;
        const dutyUsers = document.getElementById('duty-users').value;
        const usersArray = dutyUsers.split(' ').filter(u => u.trim() !== '');

        try {
            const res = await fetch(`${WORKER_API_BASE}/api/settings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cycle: dutyCycle,
                    baseDate: dutyBaseDate,
                    users: usersArray
                })
            });

            if (res.ok) {
                showToast('ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeSettingsModal();
                renderSchedule(); // ì„¤ì • ë³€ê²½ í›„ ìŠ¤ì¼€ì¤„ ìƒˆë¡œê³ ì¹¨
            } else {
                const errorData = await res.json();
                showToast(`ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ${errorData.error || res.statusText}`);
            }
        } catch (e) {
            console.error('Failed to save settings:', e);
            showToast('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }

      
      let toastTimeoutId = null; // íƒ€ì´ë¨¸ IDë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜      
      function showToast(message, duration = 1000) {
          let toast = document.getElementById('toast');
          if (!toast) {
              toast = document.createElement('div');
              toast.id = 'toast';
              document.body.appendChild(toast);
          }
      
          // ğŸ’¥ğŸ’¥ğŸ’¥ ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆë‹¤ë©´ í´ë¦¬ì–´ (í† ìŠ¤íŠ¸ê°€ ì‚¬ë¼ì§€ì§€ ì•ŠëŠ” ë¬¸ì œ í•´ê²° í•µì‹¬!) ğŸ’¥ğŸ’¥ğŸ’¥
          if (toastTimeoutId) {
              clearTimeout(toastTimeoutId);
              toastTimeoutId = null;
          }
      
          // ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ ë° ë³´ì´ë„ë¡ ì„¤ì •
          toast.textContent = message;
          toast.style.visibility = 'visible'; // ì¦‰ì‹œ ë³´ì´ë„ë¡
          toast.style.opacity = '1';          // ë¶ˆíˆ¬ëª…í•˜ê²Œ (CSS íŠ¸ëœì§€ì…˜ ì‹œì‘)
      
          // ì§€ì •ëœ ì‹œê°„(duration) í›„ í† ìŠ¤íŠ¸ë¥¼ ì‚¬ë¼ì§€ê²Œ í•˜ëŠ” íƒ€ì´ë¨¸ ì„¤ì •
          toastTimeoutId = setTimeout(() => {
              toast.style.opacity = '0'; // íˆ¬ëª…í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤ (CSS íŠ¸ëœì§€ì…˜ ì‹œì‘)
              // opacity íŠ¸ëœì§€ì…˜ì´ ì™„ë£Œë  ì‹œê°„ì„ ê¸°ë‹¤ë¦° í›„ ìš”ì†Œë¥¼ ì™„ì „íˆ ìˆ¨ê¹ë‹ˆë‹¤.
              // CSS transitionì˜ durationê³¼ ë™ì¼í•˜ê²Œ ë§ì¶¥ë‹ˆë‹¤. (0.3s = 300ms)
              setTimeout(() => {
                  // ì´ ì‹œì ì— opacityê°€ 0ì´ ì•„ë‹ˆë©´ ë‹¤ë¥¸ í† ìŠ¤íŠ¸ê°€ ì‹œì‘ëì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í™•ì¸
                  if (toast.style.opacity === '0') { 
                      toast.style.visibility = 'hidden'; // ì™„ì „íˆ ìˆ¨ê¹€
                  }
                  toastTimeoutId = null; // íƒ€ì´ë¨¸ ID ì´ˆê¸°í™”
              }, 1000); // CSS transition-duration ê°’ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì •
          }, duration); // ${duration}ms í›„ì— ì‚¬ë¼ì§€ê¸° ì‹œì‘
      }
      // ğŸ’¥ğŸ’¥ğŸ’¥ ìŠ¤ì™€ì´í”„ ğŸ’¥ğŸ’¥ğŸ’¥      
      let touchStartX = 0;
      const SWIPE_THRESHOLD = 80;                   // ìŠ¤ì™€ì´í”„ë¡œ ì¸ì‹í•  ìµœì†Œ ì´ë™ ê±°ë¦¬ (í”½ì…€)  
      const scheduleContainer = document.querySelector('.container');  
      scheduleContainer.addEventListener('touchstart', (e) => {
          touchStartX = e.touches[0].clientX; // í„°ì¹˜ ì‹œì‘ ì§€ì ì˜ X ì¢Œí‘œ ì €ì¥
      });
      scheduleContainer.addEventListener('touchend', (e) => {
          const touchEndX = e.changedTouches[0].clientX; // í„°ì¹˜ ë ì§€ì ì˜ X ì¢Œí‘œ
          const deltaX = touchEndX - touchStartX; // Xì¶• ì´ë™ ê±°ë¦¬ ê³„ì‚°  
          if (deltaX > SWIPE_THRESHOLD) {
              prevMonth(); // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ (ì´ì „ ë‹¬ë¡œ ì´ë™)
          } else if (deltaX < -SWIPE_THRESHOLD) {
              nextMonth(); // ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ (ë‹¤ìŒ ë‹¬ë¡œ ì´ë™)
          }
      });
      // ğŸ’¥ğŸ’¥ğŸ’¥ ìŠ¤ì™€ì´í”„ ë ğŸ’¥ğŸ’¥ğŸ’¥      
    </script>
</body>
</html>
